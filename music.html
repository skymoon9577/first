<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Music · GitHub Assets — Circle UI [답변:2]</title>
<style>
  :root{--bg:#0b1220;--fg:#e9eef6;--muted:#9fb0c7;--card:#0e1626;--line:#1f2b3f;--btn:#13233d;--btnh:#1a2f50;--acc:#7bdcff;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .stage{min-width:300px;min-height:400px;height:100dvh;display:grid;place-items:center;padding:10px}
  .dial{
    width:min(92vw,620px); height:min(92vh,620px);
    min-width:300px; min-height:400px;
    border:2px solid var(--fg); border-radius:50%;
    position:relative; display:grid; place-items:center; box-sizing:border-box;
  }
  .info{position:absolute; top:6%; left:50%; transform:translateX(-50%); width:76%; text-align:center}
  #nowTitle{font-size:13px; color:var(--acc); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  #nowTime{font-size:12px; color:var(--muted); margin-top:2px}
  .bar{position:absolute; top:12%; left:12%; right:12%; height:8px; background:#0c1322; border:1px solid var(--line); border-radius:999px; cursor:pointer}
  .prog{height:100%; width:0%; background:var(--acc); border-radius:999px}
  .core{position:absolute; inset:10% 22%; border-left:2px solid var(--fg); border-right:2px solid var(--fg);
        display:grid; grid-template-rows:1fr 1.2fr 1fr; gap:8px; align-items:center}
  .slot{display:grid; place-items:center; border-top:2px solid var(--fg)}
  .slot:first-child{border-top:none}
  .side{position:absolute; top:50%; transform:translateY(-50%)} 
  .side.left{left:4%} .side.right{right:4%}
  button{background:var(--btn); color:var(--fg); border:1px solid var(--line); border-radius:14px; padding:10px 12px; cursor:pointer}
  button:hover{background:var(--btnh)}
  .round{width:52px;height:52px;border-radius:999px;display:grid;place-items:center}
  .icon{font-size:21px}
  dialog{border:none;border-radius:16px;background:var(--card);color:var(--fg);padding:0;max-width:min(860px,95vw)}
  dialog::backdrop{background:rgba(0,0,0,.55)}
  .m-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
  .m-body{max-height:64vh;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px}
  th{background:#0f1a2a;color:var(--muted);text-align:left;position:sticky;top:0}
  .row{display:flex;align-items:center;justify-content:space-between;background:#0d1526;border:1px solid var(--line);border-radius:12px;padding:8px 10px;margin:6px 10px}
  .name{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  @media (max-width:480px){
    .round{width:46px;height:46px}.bar{top:14%}
  }
</style>
</head>
<body>
<div class="stage">
  <div class="dial">
    <div class="info">
      <div id="nowTitle">-</div>
      <div id="nowTime">00:00 / 00:00</div>
    </div>
    <div class="bar" id="seek"><div class="prog" id="prog"></div></div>

    <div class="side left">
      <button id="btnPrev" class="round" title="이전"><span class="icon">⏮️</span></button>
    </div>
    <div class="side right">
      <button id="btnNext" class="round" title="다음"><span class="icon">⏭️</span></button>
    </div>

    <div class="core">
      <div class="slot">
        <button id="btnFiles" class="round" title="파일리스트"><span class="icon">📁</span></button>
      </div>
      <div class="slot">
        <div style="display:flex;gap:14px">
          <button id="btnStop" class="round" title="정지"><span class="icon">⏹️</span></button>
          <button id="btnPlay" class="round" title="재생/일시정지"><span class="icon">▶️</span></button>
        </div>
      </div>
      <div class="slot">
        <button id="btnPl" class="round" title="플레이리스트"><span class="icon">🎵</span></button>
      </div>
    </div>
  </div>
</div>

<!-- 파일리스트 모달 -->
<dialog id="dlgFiles">
  <div class="m-head"><strong>파일리스트</strong><button id="closeFiles">닫기</button></div>
  <div class="m-body">
    <table>
      <thead><tr><th>파일명</th><th style="width:110px">추가</th></tr></thead>
      <tbody id="fileTable"></tbody>
    </table>
  </div>
</dialog>

<!-- 플레이리스트 모달 -->
<dialog id="dlgPl">
  <div class="m-head"><strong>플레이리스트</strong><button id="closePl">닫기</button></div>
  <div class="m-body" id="plBody"></div>
</dialog>

<audio id="audio" preload="metadata"></audio>

<script>
/* GitHub 설정 */
const GH={owner:"skymoon9577",repo:"first",path:"assets",branch:"main"};
const AUDIO_EXT=[".mp3",".m4a",".aac",".wav",".ogg",".flac"];
const apiURL=()=>`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${GH.path}?ref=${encodeURIComponent(GH.branch)}`;
const isAudio=n=>AUDIO_EXT.some(e=>n.toLowerCase().endsWith(e));

/* 상태 */
const state={files:[],playlist:[],idx:-1};
const LS_KEY="gh_music_circle_v2";

/* 요소 */
const $=s=>document.querySelector(s);
const els={
  audio:$("#audio"), nowTitle:$("#nowTitle"), nowTime:$("#nowTime"),
  seek:$("#seek"), prog:$("#prog"),
  dlgFiles:$("#dlgFiles"), fileTable:$("#fileTable"), closeFiles:$("#closeFiles"),
  dlgPl:$("#dlgPl"), plBody:$("#plBody"), closePl:$("#closePl"),
  btnFiles:$("#btnFiles"), btnPrev:$("#btnPrev"), btnStop:$("#btnStop"),
  btnPlay:$("#btnPlay"), btnNext:$("#btnNext"), btnPl:$("#btnPl")
};
function fmt(t){ if(!isFinite(t)) return "00:00"; const m=Math.floor(t/60), s=Math.floor(t%60); return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`; }

/* 저장/복원 */
function save(){ localStorage.setItem(LS_KEY, JSON.stringify({playlist:state.playlist, idx:state.idx})); }
function restore(){
  try{ const raw=localStorage.getItem(LS_KEY); if(raw){ const d=JSON.parse(raw)||{}; state.playlist=d.playlist||[]; state.idx=(typeof d.idx==="number")?d.idx:-1; } }catch{}
}

/* 파일 로드 */
async function loadFiles(){
  const r=await fetch(apiURL());
  if(!r.ok) throw new Error("GitHub API 오류: "+r.status);
  const data=await r.json();
  state.files=(Array.isArray(data)?data:[])
    .filter(it=>it.type==="file" && isAudio(it.name))
    .map(it=>({name:it.name,url:it.download_url}));
  renderFileTable();
}
function renderFileTable(){
  els.fileTable.innerHTML="";
  if(!state.files.length){ els.fileTable.innerHTML=`<tr><td colspan="2">오디오가 없습니다.</td></tr>`; return; }
  for(const f of state.files){
    const tr=document.createElement("tr");
    const td1=document.createElement("td"); td1.textContent=f.name;
    const td2=document.createElement("td");
    const b=document.createElement("button"); b.textContent="추가"; b.onclick=()=>addToPlaylist(f);
    td2.appendChild(b); tr.append(td1,td2); els.fileTable.appendChild(tr);
  }
}

/* 플레이리스트 */
function addToPlaylist(it){ if(!state.playlist.find(x=>x.url===it.url)){ state.playlist.push({...it}); save(); renderPl(); if(state.idx===-1){ state.idx=0; loadIndex(0); } } }
function removeFromPlaylist(url){
  const i=state.playlist.findIndex(x=>x.url===url);
  if(i>=0){ state.playlist.splice(i,1); if(state.idx>=state.playlist.length) state.idx=state.playlist.length-1; save(); renderPl(); }
}
function renderPl(){
  const b=els.plBody; b.innerHTML="";
  if(!state.playlist.length){ b.innerHTML=`<div class="row"><div class="name">플레이리스트 비어있음</div></div>`; els.nowTitle.textContent="-"; els.audio.removeAttribute("src"); els.nowTime.textContent="00:00 / 00:00"; return; }
  state.playlist.forEach((it,i)=>{
    const row=document.createElement("div"); row.className="row";
    const name=document.createElement("div"); name.className="name"; name.textContent=(i===state.idx?"▶ ":"")+it.name;
    const btn=document.createElement("button"); btn.textContent="삭제"; btn.onclick=()=>removeFromPlaylist(it.url);
    row.onclick=(e)=>{ if(e.target===btn) return; state.idx=i; loadIndex(i,true); };
    row.append(name,btn); b.appendChild(row);
  });
}

/* 재생 제어 */
function loadIndex(i,auto=false){
  if(i<0||i>=state.playlist.length){ els.nowTitle.textContent="-"; els.audio.removeAttribute("src"); els.nowTime.textContent="00:00 / 00:00"; return; }
  const it=state.playlist[i];
  els.nowTitle.textContent=it.name; els.audio.src=it.url; if(auto) els.audio.play(); renderPl(); save();
}
function prev(){ if(!state.playlist.length) return; state.idx=(state.idx-1+state.playlist.length)%state.playlist.length; loadIndex(state.idx,true); }
function next(){ if(!state.playlist.length) return; state.idx=(state.idx+1)%state.playlist.length; loadIndex(state.idx,true); }
function stop(){ els.audio.pause(); els.audio.currentTime=0; }
function toggle(){ if(!els.audio.src){ if(state.idx===-1 && state.playlist.length){ state.idx=0; loadIndex(0,true);} return; } if(els.audio.paused) els.audio.play(); else els.audio.pause(); }

/* 진행바 */
function seekTo(e){
  const rect=els.seek.getBoundingClientRect();
  const ratio=Math.min(1,Math.max(0,(e.clientX-rect.left)/rect.width));
  if(isFinite(els.audio.duration)){ els.audio.currentTime=els.audio.duration*ratio; }
}

/* 이벤트 */
els.btnFiles.onclick=()=>els.dlgFiles.showModal();
els.closeFiles.onclick=()=>els.dlgFiles.close();
els.btnPl.onclick=()=>{ renderPl(); els.dlgPl.showModal(); };
els.closePl.onclick=()=>els.dlgPl.close();

els.btnPrev.onclick=prev; els.btnNext.onclick=next; els.btnStop.onclick=stop; els.btnPlay.onclick=toggle;
els.audio.addEventListener("ended", next);
els.audio.addEventListener("timeupdate", ()=>{
  const cur=els.audio.currentTime, dur=els.audio.duration||0;
  els.nowTime.textContent=`${fmt(cur)} / ${fmt(dur)}`;
  els.prog.style.width = dur ? ((cur/dur)*100).toFixed(3)+"%" : "0%";
});
els.seek.addEventListener("click", seekTo);
els.seek.addEventListener("touchstart", (e)=>{ if(e.touches&&e.touches[0]) seekTo(e.touches[0]); }, {passive:true});

/* 시작 */
restore(); renderPl();
loadFiles().catch(e=>{ console.error(e); alert("파일 목록을 불러오지 못했습니다. GitHub 설정을 확인하세요."); });
</script>
</body>
</html>
